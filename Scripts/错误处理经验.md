# 车道导流线生成器 - 错误处理经验文档

## 文档说明
本文档用于记录在开发和测试车道导流线生成器过程中遇到的错误、问题及其解决方案，以便积累处理经验。

---

## 常见错误类型

### 1. MaxScript语法错误

#### 错误：变量作用域问题
**现象**：全局变量在函数内部无法访问或修改
**原因**：MaxScript的变量作用域规则与其他语言不同
**解决方案**：
- 使用 `global` 关键字声明全局变量
- 在函数内部使用 `::variableName` 访问全局变量
- 避免在函数内部重新声明同名局部变量

#### 错误：数组索引越界
**现象**：运行时报错 "Index out of range"
**原因**：MaxScript数组索引从1开始，不是0
**解决方案**：
- 确保数组索引从1开始
- 使用 `array.count` 检查数组长度
- 添加边界检查：`if index >= 1 and index <= array.count then ...`

### 2. 几何计算错误

#### 错误：平面相交计算失败
**现象**：函数返回 `undefined` 或计算结果不正确
**原因**：
- 两个平面平行，无相交线
- 法向量计算错误
- 浮点数精度问题
**解决方案**：
- 添加平行检查：`if length direction < 0.001 then return undefined`
- 使用 `normalize` 函数确保向量单位化
- 增加容错范围处理浮点数比较

#### 错误：网格创建失败
**现象**：`mesh` 对象创建后为空或显示异常
**原因**：
- 顶点数组为空
- 面索引超出顶点范围
- 顶点坐标包含无效值（NaN、Infinity）
**解决方案**：
- 验证顶点数组：`if vertices.count == 0 then return undefined`
- 检查面索引：确保所有索引都在有效范围内
- 添加坐标验证：检查是否为有效数值

### 3. UI界面错误

#### 错误：控件事件处理异常
**现象**：点击按钮或修改参数时程序崩溃
**原因**：
- 事件处理函数中的未捕获异常
- UI控件状态不一致
- 回调函数注册失败
**解决方案**：
- 使用 `try-catch` 包装所有事件处理代码
- 添加控件状态验证
- 检查回调函数注册是否成功

#### 错误：对话框创建失败
**现象**：`createDialog` 调用失败或对话框不显示
**原因**：
- 已存在同名对话框
- 对话框定义中有语法错误
- 内存不足
**解决方案**：
- 创建前先销毁已存在的对话框
- 检查rollout定义语法
- 添加内存检查和清理

### 4. 预览系统错误

#### 错误：预览对象无法删除
**现象**：清理预览时出现 "Cannot delete node" 错误
**原因**：
- 对象已被删除但引用仍存在
- 对象被其他系统锁定
- 删除顺序问题
**解决方案**：
- 使用 `isValidNode` 检查对象有效性
- 添加删除前的解锁操作
- 使用 `try-catch` 静默处理删除错误

#### 错误：回调函数注册失败
**现象**：实时预览不工作
**原因**：
- 回调函数已注册
- 函数名冲突
- 3ds Max版本不支持
**解决方案**：
- 注册前先注销已存在的回调
- 使用唯一的函数名
- 添加版本兼容性检查

#### 错误：预览显示问题
**现象**：预览对象无法正确显示或不可见
**原因**：
- registerRedrawViewsCallback在某些3ds Max版本中不稳定
- 预览对象的显示属性设置不正确
- 线框颜色与背景色冲突导致不可见
- 预览对象的材质或渲染属性影响显示
**解决方案**：
- 在注册回调前先清理旧的回调函数
- 使用明显的线框颜色（如橙色 color 255 128 0）
- 设置预览对象属性：xray=true, renderable=false, castShadows=false
- 添加详细的调试信息来追踪预览生成过程
- 提供手动更新预览的备选方案
- 强制调用redrawViews()刷新视口显示

#### 错误：无法提取边界信息
**现象**：显示"无法提取边界信息"错误，预览和生成功能无法正常工作
**原因**：
- 选择的对象不是有效的几何体
- 对象没有有效的网格数据
- 对象的边界框计算失败
- 传入的对象参数为undefined或无效
- 对象距离太近导致计算错误
- 对象类型不正确（非GeometryClass）
**解决方案**：
- 增强对象验证：检查isValidNode和isKindOf obj GeometryClass
- 验证对象是否有网格数据：obj.mesh != undefined
- 添加详细的调试信息，显示对象名称和类型
- 检查对象距离，避免距离过近的情况
- 改进错误提示，明确指出哪个对象有问题
- 在边界框计算前后添加验证步骤
- 在结构体实例化时添加try-catch错误处理
- 分步骤验证结构体属性赋值过程
- 使用正确的MaxScript结构体实例化语法：使用命名参数方式实例化结构体

**预防措施**：
- 在选择对象时进行严格的类型和有效性检查
- 提供清晰的用户提示，说明需要选择什么类型的对象
- 添加对象信息显示，帮助用户了解选择的对象状态
- 对所有结构体操作添加异常处理
- 使用MaxScript推荐的结构体实例化语法，避免空参数调用

### 5. MaxScript结构体实例化错误

**错误描述**："类型错误: 调用需要函数或类，得到的是: undefined"

**常见原因**：
1. **错误的结构体实例化语法**：使用`StructName()`而不是命名参数方式
2. **结构体定义问题**：结构体定义不完整或语法错误
3. **作用域问题**：结构体定义不在正确的作用域中
4. **参数传递问题**：结构体参数类型不匹配
5. **缺少默认值**：结构体参数没有设置默认值

**解决方案**：
1. **使用命名参数实例化**：`StructName param1:value1 param2:value2`
2. **检查结构体定义**：确保结构体定义完整且语法正确
3. **验证作用域**：确保结构体在全局作用域或正确的局部作用域中定义
4. **参数类型检查**：确保传递给结构体的参数类型正确
5. **为结构体参数设置默认值**：`struct StructName (param1 = defaultValue1, param2 = defaultValue2)`

**预防措施**：
1. **统一使用命名参数语法**：避免使用空括号实例化结构体
2. **添加结构体验证**：在使用前验证结构体是否正确定义
3. **使用try-catch包装**：对所有结构体操作添加异常处理
4. **为所有结构体参数设置合适的默认值**：确保结构体可以正常实例化

### 6. 性能问题

#### 错误：预览更新过于频繁导致卡顿
**现象**：界面响应缓慢，3ds Max假死
**原因**：
- 没有实现节流控制
- 预览对象过于复杂
- 内存泄漏
**解决方案**：
- 实现时间间隔控制：`if (currentTime - lastUpdateTime) < 200 then return`
- 简化预览几何体
- 及时清理临时对象

---

## 调试技巧

### 1. 使用 format 输出调试信息
```maxscript
format "Debug: variable value = %\n" variableName
```

### 2. 检查对象有效性
```maxscript
if obj != undefined and isValidNode obj then (
    -- 安全操作
)
```

### 3. 异常处理模板
```maxscript
try (
    -- 可能出错的代码
) catch (
    local errorMsg = getCurrentException()
    format "Error: %\n" errorMsg
    return undefined
)
```

### 4. 内存管理
```maxscript
-- 及时清理大型数组
vertices = #()
faces = #()
gc()  -- 强制垃圾回收
```

---

## 测试检查清单

### 基础功能测试
- [ ] 插件正常启动和关闭
- [ ] UI界面正确显示
- [ ] 参数输入验证
- [ ] 对象选择功能
- [ ] 箭头生成功能

### 边界条件测试
- [ ] 选择0个对象
- [ ] 选择1个对象
- [ ] 选择3个或更多对象
- [ ] 选择非几何体对象
- [ ] 极小/极大参数值
- [ ] 平行平面处理

### 性能测试
- [ ] 大量箭头生成（100+）
- [ ] 长时间预览使用
- [ ] 内存使用监控
- [ ] 多次重复操作

### 兼容性测试
- [ ] 不同3ds Max版本
- [ ] 不同场景单位设置
- [ ] 不同视口配置

---

## 已知问题记录

*此部分将在实际测试过程中填充具体遇到的问题和解决方案*

### 问题 #001
**日期**：待填充
**现象**：
**原因**：
**解决方案**：
**状态**：

---

## 更新日志

- **2024-01-15**：创建错误处理经验文档
- **待更新**：根据实际测试结果添加具体问题和解决方案

---

## 注意事项

1. **测试环境**：建议在测试场景中进行，避免影响重要项目文件
2. **备份**：测试前备份重要场景文件
3. **版本控制**：记录每次修改的版本和原因
4. **文档更新**：及时更新此文档，记录新发现的问题和解决方案

---

*本文档将随着项目开发和测试的进行持续更新和完善。*