# 车道导流线工具开发指南

## 1. 核心功能
创建MaxScript工具，输入两个相交平面，生成锯齿状箭头网格。

## 2. 最小可行版本(MVP)
- 选择两个平面对象
- 计算相交区域
- 生成简单箭头网格
- 基本UI界面

## 3. 算法步骤

1. **验证输入**: 检查选中的两个对象是否为平面
2. **计算相交**: 找到两平面的相交线
3. **提取边界**: 获取距离相交线最近的两条边
4. **生成箭头**: 沿车道方向生成三角形箭头

## 4. MVP代码实现

```maxscript
-- 车道导流线生成器 v0.1 MVP版本
global LaneArrowTool

struct ArrowGenerator (
    fn validatePlanes plane1 plane2 = (
        -- 检查是否为有效平面对象
        if plane1 == undefined or plane2 == undefined then return false
        -- 简化检查：确保是几何体
        return (isKindOf plane1 GeometryClass and isKindOf plane2 GeometryClass)
    ),
    
    fn calculateArrowPositions plane1 plane2 count:5 = (
        -- 获取两平面的中心点
        local center1 = plane1.center
        local center2 = plane2.center
        local direction = normalize(center2 - center1)
        local distance = length(center2 - center1)
        
        local positions = #()
        for i = 1 to count do (
            local t = (i - 1) as float / (count - 1) as float
            local pos = center1 + direction * (distance * t)
            append positions pos
        )
        return positions
    ),
    
    fn createArrow position width:2.0 height:1.0 = (
        -- 创建简单三角形箭头
        local vertices = #(
            position + [0, height, 0],  -- 顶点
            position + [-width/2, 0, 0], -- 左下
            position + [width/2, 0, 0]   -- 右下
        )
        local faces = #([1,2,3])
        local arrowMesh = mesh vertices:vertices faces:faces
        return arrowMesh
    ),
    
    fn generateArrows plane1 plane2 params = (
        if not validatePlanes plane1 plane2 then (
            messageBox "请选择两个有效的平面对象"
            return undefined
        )
        
        local positions = calculateArrowPositions plane1 plane2 count:params.count
        local arrows = #()
        
        for pos in positions do (
            local arrow = createArrow pos width:params.width height:params.height
            append arrows arrow
        )
        
        return arrows
    )
)

-- 简单UI
rollout LaneArrowUI "导流线工具" width:200 height:150 (
    button btnSelect "选择两个平面" width:180 height:25
    spinner spnCount "箭头数量:" range:[1,20,5] type:#integer
    spinner spnWidth "宽度:" range:[0.5,10,2] type:#float
    spinner spnHeight "高度:" range:[0.5,5,1] type:#float
    button btnGenerate "生成箭头" width:180 height:30
    
    local selectedPlanes = #()
    local generator = ArrowGenerator()
    
    on btnSelect pressed do (
        if selection.count != 2 then (
            messageBox "请先选择两个对象"
        ) else (
            selectedPlanes = selection as array
            btnSelect.text = "已选择: " + selectedPlanes[1].name + ", " + selectedPlanes[2].name
        )
    )
    
    on btnGenerate pressed do (
        if selectedPlanes.count != 2 then (
            messageBox "请先选择两个平面"
            return()
        )
        
        local params = (
            struct ArrowParams (
                count = spnCount.value,
                width = spnWidth.value,
                height = spnHeight.value
            )
        )()
        
        local result = generator.generateArrows selectedPlanes[1] selectedPlanes[2] params
        if result != undefined then (
            messageBox ("成功生成 " + result.count as string + " 个箭头")
        )
    )
)

-- 启动工具
fn startLaneArrowTool = (
    if LaneArrowTool != undefined then destroyDialog LaneArrowTool
    LaneArrowTool = LaneArrowUI
    createDialog LaneArrowTool
)

-- 运行
startLaneArrowTool()
```

## 5. 使用步骤

1. 在3ds Max中创建两个相交的平面对象
2. 运行脚本启动工具界面
3. 点击"选择两个平面"并选中目标平面
4. 调整箭头参数（数量、宽度、高度）
5. 点击"生成箭头"创建导流线

## 6. 后续改进计划

- [ ] 更精确的平面相交计算
- [ ] 箭头方向自动检测
- [ ] 简单预览功能
- [ ] 参数保存/加载

## 7. 问题和解决方案

**常见问题：**
- 平面未相交：提示用户检查平面位置
- 箭头重叠：自动调整间距避免重叠
- 生成失败：显示具体错误信息并提供解决建议

**限制：**
- 仅支持简单平面对象
- 箭头生成数量建议不超过50个
- 需要手动调整复杂情况